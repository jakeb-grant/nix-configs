{ config, pkgs, lib, ... }:

let
  # Import personal configuration (gitignored, created by setup.sh)
  secrets = if builtins.pathExists ./secrets.nix
    then import ./secrets.nix
    else {
      personalInfo = {
        userName = "user";
        fullName = "Main User";
        email = "your.email@example.com";
        gitName = "";
        timezone = "America/Denver";
      };
      desktopEnvironment = "plasma";  # Default desktop environment
    };
in
{
  imports = [
    # Hardware configuration (generated by nixos-generate-config)
    ./hardware-configuration.nix

    # Shared system modules
    ../../modules/system/user.nix
    ../../modules/system/core.nix
    ../../modules/system/desktop-environment.nix

    # Desktop environment modules (always imported)
    ../../modules/system/desktop/base.nix

    # Home manager configuration
    ../../modules/home
  ]
  # Conditionally import desktop-specific modules based on secrets
  ++ lib.optionals ((secrets.desktopEnvironment or "plasma") == "plasma") [
    ../../modules/system/desktop/plasma.nix
  ]
  ++ lib.optionals ((secrets.desktopEnvironment or "plasma") == "hyprland") [
    ../../modules/system/desktop/hyprland.nix
  ]
  # Hardware modules
  ++ [
    ../../modules/system/hardware/nvidia.nix
  ];

  # Hostname
  networking.hostName = "desktop";

  # Timezone from secrets
  time.timeZone = secrets.personalInfo.timezone;

  # Main user configuration from secrets
  main-user = {
    enable = true;
    userName = secrets.personalInfo.userName;
    description = secrets.personalInfo.fullName;
    email = secrets.personalInfo.email;
    gitName = secrets.personalInfo.gitName;
  };

  # Desktop environment configuration (from secrets - single source of truth)
  desktop-environment = {
    enable = true;
    de = secrets.desktopEnvironment or "plasma";
  };

  # Desktop-specific configuration can go here
}
